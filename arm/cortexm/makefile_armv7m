
$(info "!!!!THE CUR BOARD is $(board)")

CPU_TYPE = cortex-m3
ifeq ($(board),netduinoplus2)
	CPU_TYPE = cortex-m4
endif

$(info "!!!!THE CUR CPU_TYPE is $(CPU_TYPE)")

BIN_PATH = bin/$(board)
OBJ_PATH = obj

TOOL_CHAIN = arm-none-eabi-
CC = ${TOOL_CHAIN}gcc
AS = ${TOOL_CHAIN}as
LD = ${TOOL_CHAIN}ld
NM = ${TOOL_CHAIN}nm
OBJCOPY = ${TOOL_CHAIN}objcopy
OBJDUMP = $(TOOL_CHAIN)objdump

CFLAGS		:= -Wall -g -fno-builtin -gdwarf-2 -gstrict-dwarf -mcpu=$(CPU_TYPE) -mthumb -nostartfiles  --specs=nosys.specs -std=c11 -O0 \
				-Isrc/include\
				-Isrc/platform/$(board)

$(info "!!!!THE CUR CFLAGS is $(CFLAGS)")

LDFLAGS		:= -g

objs := src/armv7m/int_vector.o \
		src/armv7m/cm3.o \
		src/armv7m/os_stdio.o \
		src/armv7m/cm3_s.o \
		src/armv7m/task.o \
		src/armv7m/lib.o \
		src/armv7m/event.o \
		src/armv7m/sem.o \
		src/armv7m/mailbox.o \
		src/armv7m/memblock.o \
		src/armv7m/timer.o \
		src/armv7m/mutex.o \
		src/armv7m/flag_group.o \
		src/armv7m/main.o \
		src/platform/$(board)/cmsdk_uart.o 

$(BIN_PATH)/rtos.bin: $(objs)
	@${LD} -T src/armv7m/armv7m.ld -o $(BIN_PATH)/rtos.elf $^
	@${OBJCOPY} -O binary -S $(BIN_PATH)/rtos.elf $@
	@${OBJDUMP} -D -m arm $(BIN_PATH)/rtos.elf > $(BIN_PATH)/rtos.dis
	@${NM} $(BIN_PATH)/rtos.elf > $(BIN_PATH)/rtos.nm

debug: $(objs)
	${LD} -T src/armv7m/armv7m.ld -o rtos.elf $^
	${OBJCOPY} -O binary -S rtos.elf rtos.bin
	${OBJDUMP} -D -m arm rtos.elf > rtos.dis
	${NM} rtos.elf > rtos.nm
	qemu-system-arm -M lm3s6965evb --armv7m rtos.bin -nographic -s -S

%.o:%.c
	${CC} $(CFLAGS) -c -o $@ $<

%.o:%.s
	${CC} $(CFLAGS) -c -o $@ $<

clean:
	rm -rf $(BIN_PATH) $(OBJ_PATH)
